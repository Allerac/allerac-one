name: Deploy to All Servers

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    # Runs on ALL runners with 'allerac-server' label
    runs-on: [self-hosted, allerac-server]

    steps:
      - name: Show server info
        run: |
          echo "=== Deploying on: $(hostname) ==="
          echo "Runner: $RUNNER_NAME"
          echo "Time: $(date)"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Rebuild and restart containers
        run: |
          docker compose down
          docker compose up -d --build

      - name: Apply database migrations
        run: |
          echo "Waiting for database to be ready..."
          sleep 10

          echo "Applying SQL migrations..."
          for migration in src/database/migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Applying: $migration"
              docker compose exec -T db psql -U postgres -d allerac < "$migration" || echo "Migration may have already been applied"
            fi
          done

      - name: Clean up old Docker images
        run: |
          docker image prune -f

      - name: Health check
        run: |
          echo "Waiting for app to start..."
          sleep 15
          if curl -sf http://localhost:8080 > /dev/null; then
            echo "✓ Health check passed on $(hostname)"
          else
            echo "⚠ Health check failed on $(hostname)"
            docker compose logs --tail=50 app
            exit 1
          fi

      - name: Ensure infrastructure services
        run: |
          if [ -f ~/docker-compose.infra.yml ]; then
            echo "Starting infrastructure services..."
            cd ~ && docker compose -f docker-compose.infra.yml up -d
          fi

      - name: Deployment summary
        run: |
          echo ""
          echo "=== Deployment Complete ==="
          echo "Host: $(hostname)"
          echo "Commit: ${{ github.sha }}"
          echo "Containers:"
          docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'
